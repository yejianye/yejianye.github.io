---
layout: post
title:  10 分钟简读经典著作 Data Warehouse Tookit（上篇）
---

数据仓库（简称数仓）是我很感兴趣的领域，也是我目前工作职责中重要的部分。想学习这个领域的同学，或许听过《 Data Warehouse Tookit 》这本由 Ralph Kimball 撰写的经典著作。不过这是一本超过600页的大部头，要啃下来真的要花不少时间。今天就分享一下这本书的核心内容，让大家了解数据仓库的一些基本知识。

我看的是这本书第三版的英文原版（2013年出版）。要知道这本书的第一版是1996年出版，经过20多年，虽然有些内容是过时的，但书的核心理念在今天仍适用。不过这本书也个缺点，过分追求内容的全面导致有时主次不清，所以有选择地跳读是必要的。

读书很重要的一点是要带着问题读，这样才能把与问题无关的部分跳读或是略读。先说说我读这本书的背景，在 Glow 我们很重视各类数据的采集，也很喜欢用数据说话。在以前的文章中提过，我们目前在用于各类产品分析的 Dashboard 有几十个，总共包含了上千张图表。虽然产品经理与分析师们用着还不错，但我觉得在底层的数据组织上太随意，没有一套理论与规范来支撑，长此下去会越搞越乱。读这本书之前，我知道数据仓库中最常用的是维度模型，但处于一知半解的状态。所以我是带着下面 4 个问题开始看这本书

- 为什么维度模型适用于商业分析？
- 维度模型的基本设计理念是怎样的？
- 如何记录所有的历史数据与变更？
- 如何把控数据的质量？

对我来说，书中最有营养的是第1, 2, 19章，前两章已经把维度建模的主要方法都介绍了，回答了我的前三个问题。第 3 - 18 章列举了这套方法在不同行业的实际应用，我根据工作相关性以及兴趣，选读了第3，5，8，14 与 15 章。第 19 章讲述了 ETL 中包含的各个子系统，其中有一个部分专门讲数据质量的管理，回答了我的第 4 个问题。Ralph 老爷子竟然可以在 ETL 中分出 34 个子系统，这也是为什么我强调这本书不能硬刚，要跳读。

当然，每个人的问题可能都不太一样，所以下面还是以科普数据仓库的基本知识为主脉络，并在相应的模块回答之前的那几个问题。由于内容还是比较多，所以我分为了上下两篇，上篇主要讲数据仓库的组成，维度模型的基本概念，以及维度模型中事实表的设计，下篇讲维度模型中维度表的设计，以及数据仓库中数据质量的把控。

数据仓库由哪些部分组成?
--------------------

![](/images/dw-architecture.png)

在最底层，我们需要将业务场景中的各类数据导入到数据仓库中，包括业务数据库、日志文件、第三方服务数据等等。这一层的目的是将企业的各类数据打通，统一存储在一个系统中。在这一层我们对源数据的结构只做少量处理或是不改动。做为数据仓库最底层的原始数据，它们不应该被业务人员直接查询。

由于业务数据库的主要任务是支持日常业务中的增删查改，而数据仓库的主要任务是支持大规模的商业分析。所以数仓底层的原始数据必须转换为更适合统计分析的数据模型。中间层是数仓的设计者根据业务流程设计的维度模型，每一个业务流程对应一张事实表以及若干维度表。在对每项业务做统计分析时，我们所关心的指标记录在事实表中，如交易金额、利润、销售量等。过滤与分组的条件则记录在维度表中，如交易时间，地区，商品种类等。在事实表的每条记录中，除了指标数据，还保存连接各维度表的外键。这个模型足够简单直观，对于非技术的业务人员来说理解起来也不困难。

最上层是构建在数仓之上的各类数据应用场景，包括在维度模型上直接进行 Ad-hoc 查询，建立统计报表，或是做数据挖掘。

若要深入了解，可以阅读第一章中的 Kimball's DW/BI Architecture

什么是维度模型？
--------------
在上一节中，我们已经介绍了维度模型的基本概念，这个模型很好的均衡了查询复杂度与数据的维护成本。

对于查询来说，最简单的模型是一张超宽的业务表，所有的查询条件都有对应的表内字段，不需要任何 join 。但坏处是这张表的维护成本很高，有大量的冗余数据，经常要修改表结构或是现有数据来适应业务的变化。对于数据库管理员来说，这张表就是一场灾难。而经典的 ER 模型是另一个极端，表的维护成本低，没有冗余数据，但对于统计查询不友好。业务人员不但要理解错综复杂的表与表之间的网状关系，而且构建统计查询的 SQL 语句的难度也很大。这些复杂的SQL语句执行时的效率也会十分低下。

维度模型就是这两者之间的一个折中，把记录核心指标的事实表与构建分组过滤条件的维度表，以外键关联。对业务人员来说，查询时有统一的语句结构，并且最多只有一级 join。对维护人员来说，为应对业务需求的变化，大部分数据表的更改都发生在数据量较小的维度表上。这是一个非常棒的设计！下图是一个维度模型的示例

![](/images/dimensional-model-example.png)

关于维度表的详细介绍，可以阅读书中第一章的 Dimensional Modeling Introduction

事实表设计
---------
事实表是维度模型的中枢，在设计事实表时最主要的问题有两个

- 定义指标
- 确定每条记录的粒度

指标大部分情况下都是数字，如果出现文本的指标，则该考虑一下它到底是指标还是维度。在分析统计中，我们会对指标数据做各种聚合，比如计算总和，平均数，中位数等等，根据对聚合操作的支持，我们可以把指标分为可加，半可加与不可加。可加的指标是最好用的，比如交易金额与销售量。无论如何切分数据，交易金额总和与销售量总和都是有意义的。半可加的指标只在某些数据切分下可以求总，比如账户余额，在多个账户之间可以求总，但若将账户以时间维度切分，就总就是没有意义的。不可加指标的例子包括销售单价或是税率。许多时候，半可加或是不可加指标是可以通过可加指标计算得到的，比如`销售单价 = 交易金额 / 销售数量`。在设计事实表中，一个原则就是我们要尽量存储可加的指标。

事实表中每条记录的粒度越小，在其之上的统计分析就越精细。所以一般来讲，我们都会以业务中最小的原子事务为粒度来构建事实表。比如在常见的购物场景中，最小的粒度并不是一个订单，而是订单中的一个子项，即购买某某商品 N 件，所以事实表的每条记录应对应订单中的一个子项。事实表设计的另一个重要原则是要保证表中每一条记录的粒度是相同的。比如一个事实表中不能有的记录是单笔订单，有的记录是订单中的一个子项。因为这样就破坏了指标的可加性，在过滤条件设置不当时，很容易得出错误的统计结果。

除了以事务为粒度的事实表外，另一种常见的类型是周期快照事实表事实表。周期的粒度可以是日，周或是月。它是对一个周期内发生的所有事务聚合得到的。它不能代替事务事实表，但可以让许多商业分析更快速便捷。毕竟，只有少数分析需要精确到每笔交易，以自然日为粒度的统计可以满足大部分需求。

有时一个业务的流程需要很多步骤，整个过程会持续较长的时间。比如一次网购，它由下单、付款、货物发出、签收等步骤组成，从头至尾可能要许多天的时间。如果我们要分析每一步到下步之间的时长、流失率等指标，最好的事实表结构是把一次网购的各个时间点做为一条记录的各个字段保存下来，这就是累积快照事实表。之前介绍的两种事实表，一条记录一旦写入后，基本不会再被更新，而累积快照事实表的每条记录在业务流程进行的过程中会被多次更新。相比插入新记录，在数据仓库中完成大批量记录更新的技术难度会更高。

关于事实表的详细介绍，可以阅读书中第二章的 Basic Fact Table Techniques

维度表的设计
----------
维度表用于辅助描述事实发生的场景，为事实增添了 who, what, where, when, how 和 why 这些细节，主要用于过滤与分组。维度属性设计是数据仓库质量的关键。

乍看之下，维度表和 ER 模型中的 Entity 表有许多相似之处，比如在客户表，商品表等都是很常见的维度表。那么在设计时，与设计业务数据库的表有哪些关键性的不同呢？

- 详细的描述性文字
- 扁平的层级
- 如何处理更新

分类是维度表的一个重要功能，而分类又往往是有层级的。这时，设计生产数据库的经验，往往会驱使我们建立一些 lookup 表来减少冗余，这里星型结构就变为了雪花结构，大部分情况下这对于数据仓库来说不是最优的。会增加业务人员使用的复杂度，也会降低查询效率。

Surrogate key
我的理解是在一定规模的公司里，很多entity是无法用natural key来统一的（比如各个部门对同一个entity用不同的natural key）

Flags and Indicators as Textual Attributes
生产环境中经常用一些缩略码或是操作代码(OP Code)，但在数仓中要描述性强的文字来表示

Conformed Dimensions
当不同表中有相同名称或是内容的字段时，要保持所有内容含义的一致性

- Type 0 Retain original: Never change
- Type 1 Overwrite 
- Type 2 Add new row
- Type 3 Add new attribute
- Type 4 Add mini-dimension
  primary keys for both base dimension and mini-dimension are added to fact table
- Type 5
  the type 4 mini-dimension by also embedding a current type 1 reference to the mini-dimension in the base dimension.
- Type 6, Type 7

上篇小结
-------
虽然数据仓库在实践中有非常多复杂的细节，但维度模型的核心理念却非常的简单，这也是为什么我想写这篇文章，给有兴趣了解数据仓库的同学做一个快速科普。大家有什么建议意见，欢迎留言。敬请期待下篇！
